server {
        listen    80;
        listen    443 ssl;
        server_name   ~^(www\.)?(.+)$;

        set    $www_subdomain    $1;
        set    $www_domain       $2;

        root    /DevProjectFiles/ws-root/www/${www_domain};

        #ssl on;
        ssl_certificate           vhosts/cert/site.pem;
        ssl_certificate_key       vhosts/cert/site.key;
        ssl_session_timeout       5m;
        ssl_ciphers               ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
        ssl_protocols             TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;

        proxy_set_header    Host             $host:$server_port;
        proxy_set_header    REMOTE-HOST      $remote_addr;
        proxy_set_header    X-Real-IP        $remote_addr;
        proxy_set_header    X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_redirect      http:// $scheme://;
        #chunked_transfer_encoding       off;

        more_set_headers "Server: Server";

        #"X-Content-Type:  $upstream_http_content_type" "X-Content-Length:  $upstream_http_content_length" "X-Last-Modified:  $upstream_http_Last_Modified";

        #ssi off;
        
        error_page   400 401 403 404 /DevProjectFiles/ws-root/www/40x.html;
        error_page   500 502 504     /DevProjectFiles/ws-root/www/40x.html;

        #default_type text/html;

        if ($badAgent) {
          return 403;
        }

        if ($mobileAgent){
          rewrite ^ http://www.ssdr.info permanent;
        }

        #----------------------------------------------------------------------
        # custom
        #----------------------------------------------------------------------

        set $iftmp "not-au";

        #----------------------------------------------------------------------
        # begin all of the pages
        #----------------------------------------------------------------------
        set $page1_cn_home "student.html";
        set $page2_cn_student "student.html";
        set $page3_en_home "teacher.html";
        set $page4_en_student "student.html";
        set $page5_en_tutor "teacher.html";
        # end   all of the pages
        #----------------------------------------------------------------------


        #----------------------------------------------------------------------
        #  variable country_code_page       
        #----------------------------------------------------------------------
        # default country_code is en_US, use variable page3_en_home;
        set $country_code_page "${page3_en_home}";

        # if country_code is zh_CN , use variable page1_cn_home;
        if ($geoip_country_code ~ CN) {
            set $country_code_page "${page1_cn_home}";
            set $iftmp "cn";
        }

        # if country_code is en_AU , use variable page3_en_home;
        if ($geoip_country_code ~ AU) {
            set $country_code_page "${page5_en_tutor}";
            set $iftmp "au";
        }
        #----------------------------------------------------------------------

        #----------------------------------------------------------------------
        if ($uri ~ "student.html") {
          set $iftmp "${iftmp}-student";
        }
        if ($uri ~ "student2.html") {
          set $iftmp "${iftmp}-student";
        }
        if ($uri ~ "teacher.html") {
          set $iftmp "${iftmp}-teacher";
        }

        if ($iftmp = "not-au-teacher") { 
          return 404;
        }
        if ($iftmp = "au-student") { 
          #return 404;
        }
        #----------------------------------------------------------------------

        location / {
            alias  /DevProjectFiles/ws-root/www/${www_domain};
            if ($mobileAgent) {
                rewrite ^.+ http://m.${www_domain}/$uri;
            }
            #echo $iftmp;
            try_files $uri /$uri /${country_code_page} @rewrite;
        }

        location /m {
            alias  /DevProjectFiles/ws-root/www/manly-mobile/;
            try_files $uri /$uri /${country_code_page} @rewrite;
        }

        location /wx {
            if ($notWxAgent) {
              return 403;
            }
            alias  /DevProjectFiles/ws-root/www/manly-wx/;
            #echo $iftmp;
            try_files $uri /$uri @rewrite;
        }

        location /download {
          rewrite ^.* https://www.pgyer.com/NrCM;
        }

        location /tutorDownload {
          rewrite ^.* https://www.pgyer.com/pnXv;
        }

        location /mobile/download {
          rewrite ^.* https://www.pgyer.com/NrCM;
        }

        location /mobile/tutorDownload {
          rewrite ^.* https://www.pgyer.com/pnXv;
        }

        location @rewrite {
            # 如果末尾不是 /, 301 跳转
            # rewrite [^\/]$ $uri/ permanent;
            return 403;
            # echo "${iftmp} ${uri} $geoip_country_code /${country_code_page}";
        }


        location /notice/ {
            sub_filter      /topflames-oa/   '/manly-mgmt/';
            sub_filter_once off;
            sub_filter_types *;
            alias /DevProjectFiles/ws-root/fileResources/notice/; 
        }

        include vhosts/projects/manly.conf;
} 